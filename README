#
# Instructions for building the Garage-O-Matic Kernel and Filesystem
#
# Host dependencies:
#   make
#   flex
#   bc
#   bison
#   gcc
#   gettext
#   git
#   libncurses5-dev
#   svn
#   texinfo
#
# Comprehensive list of dependencies found here:
# http://buildroot.uclibc.org/downloads/manual/manual.html#requirement-mandatory
#

#
# Environment
#

export RPI_PATH=/home/jarush/gom

#
# Toolchain
#

git clone https://github.com/raspberrypi/tools.git

# Add the build tools to the path
export PATH=$PATH:$RPI_PATH/tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian/bin

#
# Kernel
#

# Clone the RPI fork of the kernel
git clone https://github.com/raspberrypi/linux.git

# Clean the project
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- mrproper

cp config/linux-rpi-3.10.y.config linux/.config
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- menuconfig

make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf-
cp arch/arm/boot/zImage ../bootfs/kernel.img

#
# Buildroot
#

# Config Options:
#
# Target Architecture: ARM (little endian)
# Target Architecture Variant: generic_arm
# Toolchain  --->
#   Toolchain type: External toolchain
#   Toolchain: Custom toolchain
#   Toolchain origin: Pre-installed toolchain
#   Toolchain path: $RPI_PATH/tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian
#   Toolchain prefix: arm-linux-gnueabihf
#   External toolchain C library: glibc/eglibc
#   Toolchain has C++ support: Yes
# System configuration  --->
#   System hostname: gom
#   System banner: Welcome to Garage-O-Matic
#   Passwords encoding: sha-256
#   /dev management: Dynamic using mdev
#   Root password: root
#   Port to run a getty (login prompt) on: ttyAMA0
# Package Selection for the target  --->
#   Interpreter languages and scripting  --->
#     php: Yes
#   Networking applications  --->
#     dropbear: Yes
#     lighttpd: Yes
#       openssl support: Yes
#       zlib support: Yes
#       pcre support: Yes
#     wireless tools: Yes
#     wpa_supplicant: Yes
#       Install wpa_cli binary: Yes
#       Install wpa_passphrase binary: Yes
# Filesystem images  --->
#   cpio the root filesystem: Yes
#     Compression method: gzip

# If starting from scratch, run the following:
make raspberrypi_defconfig

# Otherwise, copy the correct buildroot config from the config/ dir to buildroot-YYYY.MM/.config
cp config/buildroot-2014.02.config buildroot-2014.02/.config

# Customize buildroot using the menuconfig
make menuconfig

# Build
make

#
# MicroSD Card
#

# Formating
sudo mkfs.vfat -n bootfs /dev/sdb1
sudo mkfs.ext4 -L rootfs /dev/sdb2

# Installing root filesystem
mount /dev/sdb2 /media/rootfs
sudo tar -xavf $RPI_PATH/buildroot-2013.02/output/images/rootfs.tar -C /media/rootfs/

# Unmounting device
sudo umount /dev/sdb1 /dev/sdb2

